name: Build Android App via API

on:
  workflow_dispatch:
    inputs:
      # This input from your original file is kept
      ref:
        description: 'The branch, tag or SHA to checkout.'
        required: true
        default: 'master'
      # NEW: Added the project_id input to receive from the API
      project_id:
        description: 'The Bendstack Project ID for the server URL'
        required: true
      app_name:
        description: 'The desired name for the mobile app'
        required: true
      logo_url:
        description: 'Public URL to the app logo image (PNG)'
        required: true

jobs:
  build:
    runs-on: ubuntu-latest
    
    # NEW: Added permissions for the job to commit changes back to the repo
    permissions:
      contents: write

    steps:
      # 1. Checkout repository (starts on the 'master' branch)
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ inputs.ref }}

      # 2. NEW: Create a new branch named after the project ID and switch to it
      - name: Create and Switch to Project Branch
        run: |
          git checkout -b ${{ inputs.project_id }}
          echo "ðŸŒ¿ Switched to new branch: ${{ inputs.project_id }}"

      # 3. Update app name and server URL in capacitor.config.json
      - name: Update App Name & Config
        run: |
          jq '.server.url = "https://${{ inputs.project_id }}.bendstack.app" | .appName = "${{ inputs.app_name }}"' capacitor.config.json > temp.json && mv temp.json capacitor.config.json
          echo "âœ… Config updated for app: ${{ inputs.app_name }}"

      # 4. Download and replace the app icon
      - name: Update App Icon
        run: |
          curl -L -o new_logo.png "${{ inputs.logo_url }}"
          echo "âœ… Logo downloaded successfully."
          for dir in android/app/src/main/res/mipmap-*; do
            # MODIFIED: Added a check to exclude the adaptive icon directory
            if [ -d "$dir" ] && [ "$(basename "$dir")" != "mipmap-anydpi-v26" ]; then
              cp new_logo.png "$dir/ic_launcher.png"
              cp new_logo.png "$dir/ic_launcher_round.png"
              echo "âœ… Replaced legacy icons in $dir"
            fi
          done
          echo "âœ… Replaced all icons"

      # 5. MODIFIED: Commit and push the changes to the NEW project branch
      - name: Commit and Push Changes
        run: |
          git config --global user.name 'GitHub Actions Bot'
          git config --global user.email 'github-actions-bot@github.com'
          git add capacitor.config.json android/app/src/main/res/
          git diff-index --quiet HEAD || git commit -m "feat(ci): Configure app for ${{ inputs.project_id }}"
          # Push the new branch to the remote repository and set it to track
          git push -u origin ${{ inputs.project_id }}
          echo "âœ… Pushed changes to branch: ${{ inputs.project_id }}"

      # --- YOUR EXISTING BUILD STEPS CONTINUE FROM HERE ---

      # 4. Set up the correct Java Development Kit version (JDK 21)
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      # 5. Set up the correct Node.js version (Node 20)
      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      # 6. Install project dependencies
      - name: Install Dependencies
        run: npm install

      # 7. Sync the web assets with the native project
      - name: Sync Capacitor Project
        run: npx cap sync android

      # 8. Make the Gradle wrapper executable
      - name: Make gradlew executable
        run: chmod +x ./android/gradlew

      # 9. Decode the keystore from the GitHub Secret
      - name: Decode Keystore
        run: echo "${{ secrets.RELEASE_KEYSTORE_BASE64 }}" | base64 --decode > android/app/my-release-key.keystore

      # 10. Build a SIGNED APK using the keystore secrets
      - name: Build Signed Android Release
        run: |
          ./android/gradlew -p ./android assembleRelease \
            -Pandroid.injected.signing.store.file=$(pwd)/android/app/my-release-key.keystore \
            -Pandroid.injected.signing.store.password='${{ secrets.RELEASE_KEYSTORE_PASSWORD }}' \
            -Pandroid.injected.signing.key.alias='${{ secrets.RELEASE_KEY_ALIAS }}' \
            -Pandroid.injected.signing.key.password='${{ secrets.RELEASE_KEY_PASSWORD }}'

      # 11. Authenticate with Google Cloud
      - name: Authenticate with Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.FIREBASE_SERVICE_ACCOUNT_JSON }}

      # 12. Upload the final signed APK to Firebase Storage
      - name: Upload APK to Firebase Storage
        uses: google-github-actions/upload-cloud-storage@v2
        with:
          path: android/app/build/outputs/apk/release/app-release.apk
          destination: ${{ secrets.FIREBASE_STORAGE_BUCKET }}/latest/app-release.apk

      # 13. Upload the signed APK as a GitHub artifact
      - name: Upload APK as Artifact
        uses: actions/upload-artifact@v4
        with:
          name: android-release-apk
          path: android/app/build/outputs/apk/release/app-release.apk